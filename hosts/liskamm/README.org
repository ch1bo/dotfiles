#+TITLE: Liskamm

A NixOS re-incarnation of my server in smaller, also old, but a bit more
powerful hardware.

| Model | Fujitsu Esprimo               |
| CPU   | Intel Core i7 6700T - 4 cores |
| RAM   | 8GB                           |
| HD    | SEAGATE BarraCuda Compute 2TB |
| HD    | SEAGATE BarraCuda Compute 2TB |

* Disk setup

Due to the lack of SATA ports in the small case, I'm now using two 2TB HDDs for the whole system in a ZFS Raid1 setup.

This was the first disk, holding the EFI boot partition:
#+begin_src
Disk /dev/disk/by-id/ata-ST2000LM015-2E8174_WDZV6EHY: 3907029168 sectors, 1.8 TiB
Sector size (logical/physical): 512/4096 bytes
Disk identifier (GUID): D11479B1-D6C1-4E64-97DC-3289DB6EE14C
Partition table holds up to 128 entries
Main partition table begins at sector 2 and ends at sector 33
First usable sector is 34, last usable sector is 3907029134
Partitions will be aligned on 2048-sector boundaries
Total free space is 2014 sectors (1007.0 KiB)

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048         1050623   512.0 MiB   EF00  EFI system partition
   2         1050624      3907029134   1.8 TiB     8300  Linux filesystem
#+end_src

Formatting and setting up a ZFS pool:

#+begin_src
mkfs.vfat -F32 -n boot /dev/disk/by-id/ata-ST2000LM015-2E8174_WDZV6EHY-part1

zpool create -o ashift=12 -O acltype=posixacl -O xattr=sa -O mountpoint=none root /dev/disk/by-id/ata-Samsung_SSD_840_EVO_250GB_S1DBNSAF260050K-part2
#+end_src

Currently the ZFS pool is setup with these data sets:

#+begin_src
zfs create -o mountpoint=none root/local
zfs create -o mountpoint=legacy root/local/nix
zfs create -o mountpoint=none root/safe
zfs create -o mountpoint=legacy root/safe/root
zfs create -o refreservation=512M -o mountpoint=none root/reserved
#+end_src

Where the =root/reserved= can be shrinked when space runs out (required for deletion on a COW file system) with

#+begin_src
zfs set refreservation=none root/reserved
#+end_src

** Adding a second disk to the ZFS pool

Partitioned the disk using a single partition and issued:
#+begin_src
zpool attach root /dev/disk/by-id/ata-ST2000LM015-2E8174_WDZV6EHY-part2 /dev/disk/by-id/ata-ST2000LM015-2E8174_WDZXFS70-part1
#+end_src

Then, zfs starts mirrorin automatically (= resilvering) where status can be seen in
#+begin_src
zpool status
#+end_src

** Old migration of rootfs from a bigger HDD into the smaller SSD using zfs

Partition the disk and copy the /boot partitition:

#+begin_src
mkfs.vfat -F32 -n boot /dev/disk/by-id/ata-Samsung_SSD_840_EVO_250GB_S1DBNSAF260050K-part1
dd if=/dev/disk/by-id/ata-WDC_WD10JPVX-22JC3T0_WD-WX11A3480983-part1 of=/dev/disk/by-id/ata-Samsung_SSD_840_EVO_250GB_S1DBNSAF260050K-part1 bs=1M status=progress
#+end_src

Create the target zpool, take a snapshot and send it to the new pool:
#+begin_src
zpool create -o ashift=12 -O acltype=posixacl -O xattr=sa -O mountpoint=none root /dev/disk/by-id/ata-Samsung_SSD_840_EVO_250GB_S1DBNSAF260050K-part2
zfs snapshot -r rpool@2022-04-30
zfs send -R rpool@2022-04-30 | zfs recv -Fdu root
#+end_src

Then, mount, =nixos-enter=, =nixos-generate-config= and =nixos-rebuild= to have a bootable system.

NOTE: Actually.. only copying non-nixos stuff would have sufficed :sweat_smile:
